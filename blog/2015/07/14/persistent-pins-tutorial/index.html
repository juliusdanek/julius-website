
<h1 id="swift-tutorial-persistent-annotations-in-mapkit-with-core-data">Swift Tutorial: Persistent Annotations in MapKit with Core Data</h1>

<h2 id="persistent-annotations-in-mapkit">Persistent Annotations in MapKit</h2>

<p>Hi everyone, in this tutorial we will use CoreData to persist pin annotations on a map using Apple’s MapKit. Basic familiarity with CoreData and iOS development is assumed. This tutorial was done for an iPhone 6 and iOS 8.</p>

<p>In Persistent-Pins we will drop pins on a mapView using the UILongPressGestureRecognizer. Dropped Pins will be immediately saved to a CoreData database. Pins can be deleted with taps. On restart, all placed Pins will have persisted on the map. My Github contains the finished project with comments, the steps can be found as commits.</p>

<p>Github link to finished project: <a href="https://github.com/juliusdanek/Persistent-Pins-Tutorial">https://github.com/juliusdanek/Persistent-Pins-Tutorial</a></p>

<h4 id="step-one---setting-up-our-model-and-coredata">Step one - Setting up our model and CoreData</h4>

<p>Let’s start by initializing the project. Create a new project in Xcode, starting from a single view application. Choose Swift as language and enable CoreData by ticking the “Use Core Data” box.</p>

<p>Your project is now ready. Checkout how CoreData is initialized in the AppDelegate.</p>

<p>Let’s navigate to our model, “Persistent-Pins”. This is where we are going to define our entity. Let’s add one entity and name it “Pin”. Add two attributes to your new “Pin” entity. “latitude” and “longitude” are both going to be attributes and will be of type “Double”. We will store our Pin’s latitude and longitude in these properties.</p>

<h4 id="step-two---setting-up-our-managed-object">Step two - Setting up our managed object</h4>

<p>Next, we are going to set up our managed object or entity. Navigate to your model “Persistent Pins” and go on “Editor”. Select “create NSManaged Object subclass…”. Choose Persistent Pins, then Pin, then change the language to Swift and save the file to your project folder (select the right group - persistent pins - in the group dropdown).</p>

<p>At the top of the file, create another import statement for MapKit. We will need CoreData to save our Pins to our model and we will need MapKit to make the Pins that we save a subclass of MKAnnotation - this will allow us to populate our map with Pins directly from CoreData.</p>

<p>Place an @objc(Pin) under your import statements to ensure compatibility with objective-c - see <a href="http://stackoverflow.com/questions/24015185/generating-swift-models-from-core-data-entities">http://stackoverflow.com/questions/24015185/generating-swift-models-from-core-data-entities</a> for more details.</p>

<p>You can see that “Pin” is already a subclass of NSManagedObject. Let’s make it a subclass of MKAnnotation as well. We will now receive an error message that our Pin does not conform to the MKAnnotation protocol. Let’s change that.</p>

<p>At the bottom of the class declaration, add the variable “coordinate” of class CLLocationCoordinate2D like so:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">var</span> <span class="nl">coordinate</span><span class="p">:</span> <span class="n">CLLocationCoordinate2D</span> <span class="p">{</span>
	        <span class="k">return</span> <span class="n">CLLocationCoordinate2D</span><span class="p">(</span><span class="nl">latitude</span><span class="p">:</span> <span class="n">latitude</span> <span class="kt">as</span> <span class="n">Double</span><span class="p">,</span> <span class="nl">longitude</span><span class="p">:</span> <span class="n">longitude</span> <span class="kt">as</span> <span class="n">Double</span><span class="p">)</span>
	    <span class="p">}</span></code></pre></div>

<p>By now you will have noticed that latitude and longitude are declared as NSNumber. The problem is that CoreData will not recognize the Swift type <strong>Double</strong>. You will simply have to convert between Doubles and NSNumbers.</p>

<p>Let’s provide our custom init method in the next step. Add this code below where you define your @NSManaged vars.</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kr">override</span> <span class="nf">init</span><span class="p">(</span><span class="nl">entity</span><span class="p">:</span> <span class="bp">NSEntityDescription</span><span class="p">,</span> <span class="n">insertIntoManagedObjectContext</span> <span class="nl">context</span><span class="p">:</span> <span class="bp">NSManagedObjectContext</span><span class="o">?</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">super</span><span class="p">.</span><span class="k">init</span><span class="p">(</span><span class="nl">entity</span><span class="p">:</span> <span class="n">entity</span><span class="p">,</span> <span class="nl">insertIntoManagedObjectContext</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">init</span><span class="p">(</span><span class="nl">annotationLatitude</span><span class="p">:</span> <span class="n">Double</span><span class="p">,</span> <span class="nl">annotationLongitude</span><span class="p">:</span> <span class="n">Double</span><span class="p">,</span> <span class="nl">context</span><span class="p">:</span> <span class="bp">NSManagedObjectContext</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="k">let</span> <span class="n">entity</span> <span class="o">=</span> <span class="bp">NSEntityDescription</span><span class="p">.</span><span class="n">entityForName</span><span class="p">(</span><span class="s">&quot;Pin&quot;</span><span class="p">,</span> <span class="nl">inManagedObjectContext</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span><span class="o">!</span>
        
        <span class="nb">super</span><span class="p">.</span><span class="k">init</span><span class="p">(</span><span class="nl">entity</span><span class="p">:</span> <span class="n">entity</span><span class="p">,</span> <span class="nl">insertIntoManagedObjectContext</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
        
        <span class="n">latitude</span> <span class="o">=</span> <span class="bp">NSNumber</span><span class="p">(</span><span class="kt">double</span><span class="o">:</span> <span class="n">annotationLatitude</span><span class="p">)</span>
        
        <span class="n">longitude</span> <span class="o">=</span> <span class="bp">NSNumber</span><span class="p">(</span><span class="kt">double</span><span class="o">:</span> <span class="n">annotationLongitude</span><span class="p">)</span>
    <span class="p">}</span></code></pre></div>

<p>Our custom init method allows us to find our entity and initialize a Pin CoreData entry with our custom latitude and longitude values. This initializer will also automatically generate your coordinate.</p>

<p><strong>Finally, navigate to your model and change the class in your Pin entity to “Pin”</strong></p>

<p>Great, we are finished creating our custom object and are done with step one. This should be the finished code:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">import</span> <span class="n">Foundation</span>
	<span class="k">import</span> <span class="n">CoreData</span>
	<span class="k">import</span> <span class="n">MapKit</span>

	<span class="k">class</span> <span class="nl">Pin</span><span class="p">:</span> <span class="bp">NSManagedObject</span><span class="p">,</span> <span class="bp">MKAnnotation</span> <span class="p">{</span>

	    <span class="p">@</span><span class="n">NSManaged</span> <span class="k">var</span> <span class="nl">latitude</span><span class="p">:</span> <span class="bp">NSNumber</span>
	    <span class="p">@</span><span class="n">NSManaged</span> <span class="k">var</span> <span class="nl">longitude</span><span class="p">:</span> <span class="bp">NSNumber</span>
	    
	    <span class="kr">override</span> <span class="k">init</span><span class="p">(</span><span class="nl">entity</span><span class="p">:</span> <span class="bp">NSEntityDescription</span><span class="p">,</span> <span class="n">insertIntoManagedObjectContext</span> <span class="nl">context</span><span class="p">:</span> <span class="bp">NSManagedObjectContext</span><span class="o">?</span><span class="p">)</span> <span class="p">{</span>
	        <span class="nb">super</span><span class="p">.</span><span class="k">init</span><span class="p">(</span><span class="nl">entity</span><span class="p">:</span> <span class="n">entity</span><span class="p">,</span> <span class="nl">insertIntoManagedObjectContext</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
	    <span class="p">}</span>
	    
	    <span class="k">init</span><span class="p">(</span><span class="nl">annotationLatitude</span><span class="p">:</span> <span class="n">Double</span><span class="p">,</span> <span class="nl">annotationLongitude</span><span class="p">:</span> <span class="n">Double</span><span class="p">,</span> <span class="nl">context</span><span class="p">:</span> <span class="bp">NSManagedObjectContext</span><span class="p">)</span> <span class="p">{</span>
	        <span class="k">let</span> <span class="n">entity</span> <span class="o">=</span> <span class="bp">NSEntityDescription</span><span class="p">.</span><span class="n">entityForName</span><span class="p">(</span><span class="s">&quot;Pin&quot;</span><span class="p">,</span> <span class="nl">inManagedObjectContext</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span><span class="o">!</span>
	        <span class="nb">super</span><span class="p">.</span><span class="k">init</span><span class="p">(</span><span class="nl">entity</span><span class="p">:</span> <span class="n">entity</span><span class="p">,</span> <span class="nl">insertIntoManagedObjectContext</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
	        <span class="n">latitude</span> <span class="o">=</span> <span class="bp">NSNumber</span><span class="p">(</span><span class="kt">double</span><span class="o">:</span> <span class="n">annotationLatitude</span><span class="p">)</span>
	        <span class="n">longitude</span> <span class="o">=</span> <span class="bp">NSNumber</span><span class="p">(</span><span class="kt">double</span><span class="o">:</span> <span class="n">annotationLongitude</span><span class="p">)</span>
	    <span class="p">}</span>
	    
	    <span class="k">var</span> <span class="nl">coordinate</span><span class="p">:</span> <span class="n">CLLocationCoordinate2D</span> <span class="p">{</span>
	        <span class="k">return</span> <span class="n">CLLocationCoordinate2D</span><span class="p">(</span><span class="nl">latitude</span><span class="p">:</span> <span class="n">latitude</span> <span class="kt">as</span> <span class="n">Double</span><span class="p">,</span> <span class="nl">longitude</span><span class="p">:</span> <span class="n">longitude</span> <span class="kt">as</span> <span class="n">Double</span><span class="p">)</span>
	    <span class="p">}</span>

	<span class="p">}</span></code></pre></div>

<h4 id="step-two----setting-up-our-ui-and-our-viewcontroller">Step two – setting up our UI and our ViewController</h4>

<p>Navigate to storyboard and drag a MapKit View onto your viewcontroller. Set the constraints so the MapView fills out the entire controller. Also, do not forget to enable MapKit in your projects capabilities. Go to persistent Pins and enable “Maps” under capabilities.</p>

<p>Let’s create an outlet for our mapView in our ViewController file. ctrl + drag your mapView into your ViewController using the assistant editor and add an outlet named “mapView”. Do not forget to import MapKit into your ViewController and set your ViewController as MKMapViewDelegate.</p>

<p>In our viewDidLoad method, let’s add a long pressure gesture recognizer that will allow us to drop pins.</p>

<p>Your ViewController should look like this now:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">import</span> <span class="n">UIKit</span>
	<span class="k">import</span> <span class="n">MapKit</span>

	<span class="k">class</span> <span class="nl">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span><span class="p">,</span> <span class="bp">MKMapViewDelegate</span> <span class="p">{</span>

	    <span class="p">@</span><span class="kt">IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nl">mapView</span><span class="p">:</span> <span class="bp">MKMapView</span><span class="o">!</span>
	    
	    <span class="kr">override</span> <span class="k">func</span> <span class="n">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
	        <span class="nb">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
	        
	        <span class="k">var</span> <span class="n">longPress</span> <span class="o">=</span> <span class="bp">UILongPressGestureRecognizer</span><span class="p">(</span><span class="nl">target</span><span class="p">:</span> <span class="nb">self</span><span class="p">,</span> <span class="nl">action</span><span class="p">:</span> <span class="s">&quot;dropPin:&quot;</span><span class="p">)</span>
	        <span class="n">longPress</span><span class="p">.</span><span class="n">minimumPressDuration</span> <span class="o">=</span> <span class="mf">0.5</span>
	        <span class="n">mapView</span><span class="p">.</span><span class="n">addGestureRecognizer</span><span class="p">(</span><span class="n">longPress</span><span class="p">)</span>
	        
	        <span class="n">mapView</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
	        
	    <span class="p">}</span>
	<span class="p">}</span></code></pre></div>

<p>As you can see, the UILongPressGestureRecognizer us linked to a method called dropPin. We will implement that method next.</p>

<h4 id="step-three---the-droppin-method">Step three - the dropPin method</h4>

<p>Let’s define our dropPin method. We will have to do three things:</p>

<ol>
  <li>Extract the coordinates from the point where the user touched</li>
  <li>Add an annotation when the UIGestureRecognizerState fires</li>
  <li>Save that annotation to CoreData</li>
</ol>

<p>Let’s start by defining the function and extracting location data:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">func</span> <span class="nf">dropPin</span><span class="p">(</span><span class="nl">gestureRecognizer</span><span class="p">:</span> <span class="bp">UIGestureRecognizer</span><span class="p">)</span> <span class="p">{</span>
	        
	        <span class="k">let</span> <span class="nl">tapPoint</span><span class="p">:</span> <span class="bp">CGPoint</span> <span class="o">=</span> <span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">locationInView</span><span class="p">(</span><span class="n">mapView</span><span class="p">)</span>
	        <span class="k">let</span> <span class="nl">touchMapCoordinate</span><span class="p">:</span> <span class="n">CLLocationCoordinate2D</span> <span class="o">=</span> <span class="n">mapView</span><span class="p">.</span><span class="n">convertPoint</span><span class="p">(</span><span class="n">tapPoint</span><span class="p">,</span> <span class="nl">toCoordinateFromView</span><span class="p">:</span> <span class="n">mapView</span><span class="p">)</span>
	    <span class="p">}</span></code></pre></div>

<p>Now, this method does not really do much yet. Let’s add a pin!</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">func</span> <span class="nf">dropPin</span><span class="p">(</span><span class="nl">gestureRecognizer</span><span class="p">:</span> <span class="bp">UIGestureRecognizer</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="k">let</span> <span class="nl">tapPoint</span><span class="p">:</span> <span class="bp">CGPoint</span> <span class="o">=</span> <span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">locationInView</span><span class="p">(</span><span class="n">mapView</span><span class="p">)</span>
        <span class="k">let</span> <span class="nl">touchMapCoordinate</span><span class="p">:</span> <span class="n">CLLocationCoordinate2D</span> <span class="o">=</span> <span class="n">mapView</span><span class="p">.</span><span class="n">convertPoint</span><span class="p">(</span><span class="n">tapPoint</span><span class="p">,</span> <span class="nl">toCoordinateFromView</span><span class="p">:</span> <span class="n">mapView</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">UIGestureRecognizerState</span><span class="p">.</span><span class="n">Began</span> <span class="o">==</span> <span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">state</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">pin</span> <span class="o">=</span> <span class="bp">MKPointAnnotation</span><span class="p">()</span>
            <span class="n">pin</span><span class="p">.</span><span class="n">coordinate</span> <span class="o">=</span> <span class="n">touchMapCoordinate</span>
            <span class="n">mapView</span><span class="p">.</span><span class="n">addAnnotation</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>           
        <span class="p">}</span>
    <span class="p">}</span></code></pre></div>

<p>Now we can see pins dropping where we touched. This implementation is fairly straightforward. Our pins are not persistent yet though! Let’s change our dropPin function with this code:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">func</span> <span class="nf">dropPin</span><span class="p">(</span><span class="nl">gestureRecognizer</span><span class="p">:</span> <span class="bp">UIGestureRecognizer</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="k">let</span> <span class="nl">tapPoint</span><span class="p">:</span> <span class="bp">CGPoint</span> <span class="o">=</span> <span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">locationInView</span><span class="p">(</span><span class="n">mapView</span><span class="p">)</span>
        <span class="k">let</span> <span class="nl">touchMapCoordinate</span><span class="p">:</span> <span class="n">CLLocationCoordinate2D</span> <span class="o">=</span> <span class="n">mapView</span><span class="p">.</span><span class="n">convertPoint</span><span class="p">(</span><span class="n">tapPoint</span><span class="p">,</span> <span class="nl">toCoordinateFromView</span><span class="p">:</span> <span class="n">mapView</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">UIGestureRecognizerState</span><span class="p">.</span><span class="n">Began</span> <span class="o">==</span> <span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">state</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">appDelegate</span> <span class="o">=</span> <span class="bp">UIApplication</span><span class="p">.</span><span class="n">sharedApplication</span><span class="p">().</span><span class="n">delegate</span> <span class="kt">as</span><span class="o">!</span> <span class="n">AppDelegate</span>
            
            <span class="k">let</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="nl">annotationLatitude</span><span class="p">:</span> <span class="n">touchMapCoordinate</span><span class="p">.</span><span class="n">latitude</span><span class="p">,</span> <span class="nl">annotationLongitude</span><span class="p">:</span> <span class="n">touchMapCoordinate</span><span class="p">.</span><span class="n">longitude</span><span class="p">,</span> <span class="nl">context</span><span class="p">:</span> <span class="n">appDelegate</span><span class="p">.</span><span class="n">managedObjectContext</span><span class="o">!</span><span class="p">)</span>
            <span class="n">mapView</span><span class="p">.</span><span class="n">addAnnotation</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
            <span class="n">appDelegate</span><span class="p">.</span><span class="n">saveContext</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span></code></pre></div>

<p>We will instantiate the appDelegate so we can use its methods. Then we proceed to instantiate a pin as our Pin class. We will initialize it with the coordinates from our touchMapCoordinate and use the appDelegate context as our context. Then we add the pin to our map view and we save our context - we could do this at another point too but it seems smart to do it here. We just successfully added a Pin to our CoreData model!</p>

<h4 id="step-four---fetching-our-pins-and-adding-them-to-our-map-when-starting-our-app">Step four - fetching our Pins and adding them to our map when starting our app</h4>

<p>Alright, let’s make sure that the pins that we insert into CoreData also get fetched when we need them, i.e. when the mapView loads. Let’s first change some of the logic that we implemented before. Import CoreData to our ViewController. Let’s also declare two implicitly unwrapped variables in ViewController:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">var</span> <span class="nl">appDelegate</span><span class="p">:</span> <span class="n">AppDelegate</span><span class="o">!</span>
    <span class="k">var</span> <span class="nl">sharedContext</span><span class="p">:</span> <span class="bp">NSManagedObjectContext</span><span class="o">!</span></code></pre></div>

<p>Next, in our viewDidLoad method, at the very top, initialize the two new variables as so:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">appDelegate</span> <span class="o">=</span> <span class="bp">UIApplication</span><span class="p">.</span><span class="n">sharedApplication</span><span class="p">().</span><span class="n">delegate</span> <span class="kt">as</span><span class="o">!</span> <span class="n">AppDelegate</span>
        <span class="n">sharedContext</span> <span class="o">=</span> <span class="n">appDelegate</span><span class="p">.</span><span class="n">managedObjectContext</span></code></pre></div>

<p>this allows us to access our NSManagedObjectContext and our saveContext() method throughout the ViewController. 
Do not forget to adjust the dropPin method accordingly! Delete the declaration of appDelegate that we had before and use the sharedContext variable in our init method.</p>

<p>Alright, let’s create a method for a fetchrequest! Simply use this code:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">func</span> <span class="n">fetchAllPins</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">Pin</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nl">error</span><span class="p">:</span> <span class="n">NSErrorPointer</span> <span class="o">=</span> <span class="nb">nil</span>
        <span class="k">let</span> <span class="n">fetchRequest</span> <span class="o">=</span> <span class="bp">NSFetchRequest</span><span class="p">(</span><span class="nl">entityName</span><span class="p">:</span> <span class="s">&quot;Pin&quot;</span><span class="p">)</span>
        <span class="k">let</span> <span class="n">results</span> <span class="o">=</span> <span class="n">sharedContext</span><span class="p">.</span><span class="n">executeFetchRequest</span><span class="p">(</span><span class="n">fetchRequest</span><span class="p">,</span> <span class="nl">error</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span> <span class="o">!=</span> <span class="nb">nil</span> <span class="p">{</span>
            <span class="n">println</span><span class="p">(</span><span class="s">&quot;Error in fectchAllActors(): \(error)&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">results</span> <span class="kt">as</span><span class="o">!</span> <span class="p">[</span><span class="n">Pin</span><span class="p">]</span>
    <span class="p">}</span></code></pre></div>

<p>We create a fetchrequest, then execute it. In case there are any errors, we print the error to the console. The results are then returned as an array of pins. Now that we have a method can allows us to access our Pins as an array, let’s put them on the map! At the bottom of our viewDidLoad method, add the following code:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="n">mapView</span><span class="p">.</span><span class="n">addAnnotations</span><span class="p">(</span><span class="n">fetchAllPins</span><span class="p">())</span></code></pre></div>

<p>Great, now we are able to see the pins that we add. Let’s try it out.</p>

<h4 id="step-five---deleting-pins">Step five - deleting pins</h4>

<p>This step is remarkably easy. We will implement one of our delegate methods - didSelectAnnotation. The wonderful thing is that all mapView.annotations are saved as an array - an array of Pins! That means the selected annotation can always be casted as a Pin and deleted from the managed context. The method should look like this:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">func</span> <span class="nf">mapView</span><span class="p">(</span><span class="nl">mapView</span><span class="p">:</span> <span class="bp">MKMapView</span><span class="o">!</span><span class="p">,</span> <span class="n">didSelectAnnotationView</span> <span class="nl">view</span><span class="p">:</span> <span class="bp">MKAnnotationView</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">view</span><span class="p">.</span><span class="n">annotation</span> <span class="kt">as</span><span class="o">!</span> <span class="n">Pin</span>
        <span class="n">sharedContext</span><span class="p">.</span><span class="n">deleteObject</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
        <span class="n">mapView</span><span class="p">.</span><span class="n">removeAnnotation</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
        <span class="n">appDelegate</span><span class="p">.</span><span class="n">saveContext</span><span class="p">()</span>
    <span class="p">}</span></code></pre></div>

<p>That was our last method! Our viewController should now look like this:</p>

<div class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">import</span> <span class="n">CoreData</span>
<span class="k">import</span> <span class="n">UIKit</span>
<span class="k">import</span> <span class="n">MapKit</span>

<span class="k">class</span> <span class="nl">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span><span class="p">,</span> <span class="bp">MKMapViewDelegate</span> <span class="p">{</span>

    <span class="p">@</span><span class="kt">IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nl">mapView</span><span class="p">:</span> <span class="bp">MKMapView</span><span class="o">!</span>
    
    <span class="k">var</span> <span class="nl">appDelegate</span><span class="p">:</span> <span class="n">AppDelegate</span><span class="o">!</span>
    <span class="k">var</span> <span class="nl">sharedContext</span><span class="p">:</span> <span class="bp">NSManagedObjectContext</span><span class="o">!</span>
    
    <span class="kr">override</span> <span class="k">func</span> <span class="n">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="nb">super</span><span class="p">.</span><span class="n">viewDidLoad</span><span class="p">()</span>
        
        <span class="n">appDelegate</span> <span class="o">=</span> <span class="bp">UIApplication</span><span class="p">.</span><span class="n">sharedApplication</span><span class="p">().</span><span class="n">delegate</span> <span class="kt">as</span><span class="o">!</span> <span class="n">AppDelegate</span>
        
        <span class="n">sharedContext</span> <span class="o">=</span> <span class="n">appDelegate</span><span class="p">.</span><span class="n">managedObjectContext</span>
        
        <span class="k">var</span> <span class="n">longPress</span> <span class="o">=</span> <span class="bp">UILongPressGestureRecognizer</span><span class="p">(</span><span class="nl">target</span><span class="p">:</span> <span class="nb">self</span><span class="p">,</span> <span class="nl">action</span><span class="p">:</span> <span class="s">&quot;dropPin:&quot;</span><span class="p">)</span>
        <span class="n">longPress</span><span class="p">.</span><span class="n">minimumPressDuration</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">mapView</span><span class="p">.</span><span class="n">addGestureRecognizer</span><span class="p">(</span><span class="n">longPress</span><span class="p">)</span>
        
        <span class="n">mapView</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span>
        
        <span class="n">mapView</span><span class="p">.</span><span class="n">addAnnotations</span><span class="p">(</span><span class="n">fetchAllPins</span><span class="p">())</span>
    <span class="p">}</span>
    
    <span class="k">func</span> <span class="n">dropPin</span><span class="p">(</span><span class="nl">gestureRecognizer</span><span class="p">:</span> <span class="bp">UIGestureRecognizer</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="k">let</span> <span class="nl">tapPoint</span><span class="p">:</span> <span class="bp">CGPoint</span> <span class="o">=</span> <span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">locationInView</span><span class="p">(</span><span class="n">mapView</span><span class="p">)</span>
        <span class="k">let</span> <span class="nl">touchMapCoordinate</span><span class="p">:</span> <span class="n">CLLocationCoordinate2D</span> <span class="o">=</span> <span class="n">mapView</span><span class="p">.</span><span class="n">convertPoint</span><span class="p">(</span><span class="n">tapPoint</span><span class="p">,</span> <span class="nl">toCoordinateFromView</span><span class="p">:</span> <span class="n">mapView</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">UIGestureRecognizerState</span><span class="p">.</span><span class="n">Began</span> <span class="o">==</span> <span class="n">gestureRecognizer</span><span class="p">.</span><span class="n">state</span> <span class="p">{</span>
            <span class="k">let</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">Pin</span><span class="p">(</span><span class="nl">annotationLatitude</span><span class="p">:</span> <span class="n">touchMapCoordinate</span><span class="p">.</span><span class="n">latitude</span><span class="p">,</span> <span class="nl">annotationLongitude</span><span class="p">:</span> <span class="n">touchMapCoordinate</span><span class="p">.</span><span class="n">longitude</span><span class="p">,</span> <span class="nl">context</span><span class="p">:</span> <span class="n">appDelegate</span><span class="p">.</span><span class="n">managedObjectContext</span><span class="o">!</span><span class="p">)</span>
            <span class="n">mapView</span><span class="p">.</span><span class="n">addAnnotation</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
            <span class="n">appDelegate</span><span class="p">.</span><span class="n">saveContext</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">func</span> <span class="n">mapView</span><span class="p">(</span><span class="nl">mapView</span><span class="p">:</span> <span class="bp">MKMapView</span><span class="o">!</span><span class="p">,</span> <span class="n">didSelectAnnotationView</span> <span class="nl">view</span><span class="p">:</span> <span class="bp">MKAnnotationView</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">pin</span> <span class="o">=</span> <span class="n">view</span><span class="p">.</span><span class="n">annotation</span> <span class="kt">as</span><span class="o">!</span> <span class="n">Pin</span>
        <span class="n">sharedContext</span><span class="p">.</span><span class="n">deleteObject</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
        <span class="n">mapView</span><span class="p">.</span><span class="n">removeAnnotation</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
        <span class="n">appDelegate</span><span class="p">.</span><span class="n">saveContext</span><span class="p">()</span>
    <span class="p">}</span>
    
    
    <span class="k">func</span> <span class="n">fetchAllPins</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">Pin</span><span class="p">]</span> <span class="p">{</span>
        
        <span class="k">let</span> <span class="nl">error</span><span class="p">:</span> <span class="n">NSErrorPointer</span> <span class="o">=</span> <span class="nb">nil</span>
        <span class="k">let</span> <span class="n">fetchRequest</span> <span class="o">=</span> <span class="bp">NSFetchRequest</span><span class="p">(</span><span class="nl">entityName</span><span class="p">:</span> <span class="s">&quot;Pin&quot;</span><span class="p">)</span>
        <span class="k">let</span> <span class="n">results</span> <span class="o">=</span> <span class="n">sharedContext</span><span class="p">.</span><span class="n">executeFetchRequest</span><span class="p">(</span><span class="n">fetchRequest</span><span class="p">,</span> <span class="nl">error</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span> <span class="o">!=</span> <span class="nb">nil</span> <span class="p">{</span>
            <span class="n">println</span><span class="p">(</span><span class="s">&quot;Error in fectchAllActors(): \(error)&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">results</span> <span class="kt">as</span><span class="o">!</span> <span class="p">[</span><span class="n">Pin</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>Tada! We are finished. Additional modification could include: Adding data like photos to a Pin, and defining a relationship between a Photo and the Pin object, using NSFetchResultsController to get results and update UI, modifying appearance of the Pins, displaying user location on map, etc.</p>

<p>I hope you enjoyed this tutorial!</p>

